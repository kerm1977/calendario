<!-- templates/calendar.html -->
{% extends "base.html" %}

{% block title %}Panel Admin - Calendario{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3 animate__animated animate__fadeIn">
    <h2 class="mb-0 fw-bold">{{ month_name }} {{ year }}</h2>
    
    <div class="btn-group shadow-sm">
        <a href="{{ url_for('calendar_view.view', year=year, month=month-1) }}" class="btn btn-outline-warning">
            <i class="bi bi-chevron-left"></i>
        </a>
        <a href="{{ url_for('calendar_view.view') }}" class="btn btn-outline-warning">Hoy</a>
        <a href="{{ url_for('calendar_view.view', year=year, month=month+1) }}" class="btn btn-outline-warning">
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>

    <button class="btn btn-warning fw-bold shadow-sm text-dark px-4 rounded-pill" data-bs-toggle="modal" data-bs-target="#addEventModal">
        <i class="bi bi-plus-lg me-2"></i>Crear Actividad
    </button>
</div>

<!-- Estructura del Calendario con CSS Grid -->
<div class="calendar-wrapper shadow-sm rounded-4 overflow-hidden border bg-white">
    <!-- Encabezado de días -->
    <div class="calendar-header-grid bg-warning text-dark py-3 fw-bold border-bottom text-center">
        <div>Lun</div>
        <div>Mar</div>
        <div>Mié</div>
        <div>Jue</div>
        <div>Vie</div>
        <div>Sáb</div>
        <div>Dom</div>
    </div>

    <!-- Cuadrícula de días -->
    <div class="calendar-days-grid">
        {% for week in weeks %}
            {% for day in week %}
                <div class="calendar-cell {% if day == 0 %}empty bg-light bg-opacity-50{% else %}clickable-cell{% endif %}" 
                     {% if day != 0 %}onclick="openAddModal({{ day }})"{% endif %}>
                    
                    {% if day != 0 %}
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="day-number fw-bold fs-5">{{ day }}</span>
                        </div>
                        
                        <div class="event-stack">
                            {% for event in events %}
                                {% if event.event_date.day == day and event.event_date.month == month and event.event_date.year == year %}
                                    <div class="event-pill {{ 'bg-warning text-dark border-warning' if event.status == 'Se Traslado' else 'bg-warning bg-opacity-10 text-warning-emphasis border-warning' }}" 
                                         title="{{ event.title }}">
                                        {% if event.status == 'Se Traslado' %}<i class="bi bi-arrow-right-circle me-1"></i>{% endif %}
                                        <span class="text-truncate">{{ event.title }}</span>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>

<!-- Modal para añadir evento (Crear Actividad) -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form class="modal-content border-0 shadow-lg rounded-4 overflow-hidden" id="addEventForm" action="{{ url_for('calendar_view.add_event') }}" method="POST" enctype="multipart/form-data">
            <div class="modal-header bg-warning text-dark border-0">
                <h5 class="modal-title fw-bold"><i class="bi bi-calendar-plus me-2"></i>Configurar Nueva Actividad</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 bg-body">
                <div class="row g-3">
                    <!-- Sección 1: Datos Principales -->
                    <div class="col-md-12"><h6 class="border-bottom pb-2 fw-bold text-warning">Información General</h6></div>
                    
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Imagen del Evento (Flyer)</label>
                        <input type="file" name="flyer" class="form-control border-warning" accept="image/*">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Nombre del Evento</label>
                        <input type="text" name="title" class="form-control border-warning" required placeholder="Nombre de la aventura">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Moneda</label>
                        <select name="currency" class="form-select border-warning">
                            <option value="¢">Colones (¢)</option>
                            <option value="$">Dólares ($)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Precio (Monto)</label>
                        <input type="number" step="0.01" name="price" class="form-control border-warning" placeholder="0.00">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Puntos a otorgar</label>
                        <input type="number" name="points_reward" class="form-control border-warning" value="10">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Actividad</label>
                        <select name="activity_type" class="form-select border-warning">
                            <option>Caminata</option>
                            <option>El Camino de Costa Rica</option>
                            <option>Parque Nacional</option>
                            <option>Internacional</option>
                            <option>Convivio</option>
                            <option>Fiesta de Fin de Año</option>
                            <option>Taller</option>
                        </select>
                    </div>

                    <!-- Sección 2: Tiempos -->
                    <div class="col-md-12"><h6 class="border-bottom pb-2 fw-bold text-warning">Duración y Fechas</h6></div>
                    
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Cantidad Días (1 al 10)</label>
                        <input type="number" name="duration_days" id="durationDays" class="form-control border-warning" min="1" max="10" value="1">
                    </div>
                    
                    <div class="col-md-4" id="startDateContainer">
                        <label class="form-label small fw-bold" id="labelEventDate">Fecha de Actividad</label>
                        <input type="date" name="event_date" id="eventDateInput" class="form-control border-warning" required>
                    </div>

                    <div class="col-md-4 d-none" id="endDateContainer">
                        <label class="form-label small fw-bold">Fecha de Cierre de Actividad</label>
                        <input type="date" name="end_date" class="form-control border-warning">
                    </div>

                    <!-- Sección 3: Detalle del Evento -->
                    <div class="col-md-12"><h6 class="border-bottom pb-2 fw-bold text-warning">Detalle del Evento</h6></div>
                    
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Salida de</label>
                        <select name="departure_point" class="form-select border-warning">
                            <option>Parque de Tres Ríos - Escuela</option>
                            <option>Parque de Tres Ríos - Cruz Roja</option>
                            <option>Parque de Tres Ríos - Letras</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Hora de Salida</label>
                        <input type="time" name="departure_time" class="form-control border-warning">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">Dificultad</label>
                        <select name="difficulty" class="form-select border-warning">
                            <option>Básica</option>
                            <option>Paseo</option>
                            <option>Intermedio</option>
                            <option>Intermedio - Dificil</option>
                            <option>Dificil</option>
                            <option>Avanzado</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Distancia</label>
                        <input type="text" name="distance" class="form-control border-warning" placeholder="Ej: 15km">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Capacidad</label>
                        <input type="number" name="capacity" class="form-control border-warning" placeholder="Lugares disponibles">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Reserva con</label>
                        <input type="text" name="reservation_fee" class="form-control border-warning" placeholder="Monto para reservar">
                    </div>

                    <div class="col-md-12">
                        <label class="form-label small fw-bold">Se recoge en</label>
                        <input type="text" name="pickup_point" class="form-control border-warning" placeholder="Puntos adicionales de recogida">
                    </div>

                    <div class="col-md-12">
                        <label class="form-label small fw-bold">Descripción</label>
                        <textarea name="description" class="form-control border-warning" rows="3" placeholder="Detalles generales..."></textarea>
                    </div>

                    <!-- Sección 4: Estados y Traslados -->
                    <div class="col-md-12"><h6 class="border-bottom pb-2 fw-bold text-warning">Estado de la Actividad</h6></div>
                    
                    <div class="col-md-6">
                        <label class="form-label small fw-bold">Estado</label>
                        <select name="status" id="statusSelect" class="form-select border-warning">
                            <option value="Activa">Activa</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Suspendido">Suspendido</option>
                            <option value="Se Traslado">Se Traslado</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 d-none" id="movedDateContainer">
                        <label class="form-label small fw-bold">Nueva Fecha de Traslado</label>
                        <input type="date" name="moved_date" class="form-control border-warning">
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light border-0">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-warning fw-bold text-dark rounded-pill px-4">Guardar Actividad</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* RECONSTRUCCIÓN DEL CALENDARIO VISUAL */
    .calendar-header-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        background-color: #ffc107;
    }

    .calendar-days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background-color: #dee2e6;
        gap: 1px; /* Espacio para las líneas de división */
    }

    .calendar-cell {
        min-height: 140px;
        background-color: #fff;
        padding: 10px;
        transition: background-color 0.2s ease;
    }

    .clickable-cell:hover {
        background-color: #fffdf5;
        cursor: pointer;
    }

    .day-number {
        color: #adb5bd;
    }

    .clickable-cell .day-number {
        color: #212529;
    }

    .event-stack {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .event-pill {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 6px;
        border-left: 3px solid #ffc107;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
    }

    /* Adaptación a Modo Oscuro */
    [data-bs-theme="dark"] .calendar-cell {
        background-color: #1a1a1a;
    }
    [data-bs-theme="dark"] .calendar-cell.empty {
        background-color: #121212;
    }
    [data-bs-theme="dark"] .clickable-cell:hover {
        background-color: #252525;
    }
    [data-bs-theme="dark"] .day-number {
        color: #fff;
    }
    [data-bs-theme="dark"] .calendar-days-grid {
        background-color: #333;
    }

    /* Mejora de inputs */
    .form-control:focus, .form-select:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
    }
</style>

<script>
/**
 * Función para abrir el modal al hacer click en un día.
 * @param {number} day - El número del día seleccionado.
 */
function openAddModal(day) {
    const year = {{ year }};
    const month = String({{ month }}).padStart(2, '0');
    const dayStr = String(day).padStart(2, '0');
    const dateStr = `${year}-${month}-${dayStr}`;
    
    // Referencia al campo de fecha
    const dateInput = document.getElementById('eventDateInput');
    const durationInput = document.getElementById('durationDays');
    
    if (dateInput) {
        // Establecer la fecha en el input del formulario
        dateInput.value = dateStr;
        
        // Resetear duración a 1 para asegurar consistencia
        if (durationInput) {
            durationInput.value = 1;
            // Forzar actualización de etiquetas de Jinja/JS
            durationInput.dispatchEvent(new Event('input'));
        }
    }
    
    // Mostrar modal usando el objeto global de Bootstrap
    const modalElement = document.getElementById('addEventModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

document.addEventListener('DOMContentLoaded', function() {
    const durationInput = document.getElementById('durationDays');
    const labelDate = document.getElementById('labelEventDate');
    const endDateContainer = document.getElementById('endDateContainer');
    
    const statusSelect = document.getElementById('statusSelect');
    const movedDateContainer = document.getElementById('movedDateContainer');

    // Lógica para cantidad de días (mostrar/ocultar fecha de cierre)
    if (durationInput) {
        durationInput.addEventListener('input', function() {
            const days = parseInt(this.value) || 1;
            if (days > 1) {
                labelDate.innerText = "Fecha de Inicio de Actividad";
                endDateContainer.classList.remove('d-none');
            } else {
                labelDate.innerText = "Fecha de Actividad";
                endDateContainer.classList.add('d-none');
            }
        });
    }

    // Lógica para el estado "Se Traslado" (mostrar/ocultar fecha nueva)
    if (statusSelect) {
        statusSelect.addEventListener('change', function() {
            if (this.value === 'Se Traslado') {
                movedDateContainer.classList.remove('d-none');
            } else {
                movedDateContainer.classList.add('d-none');
            }
        });
    }
});
</script>
{% endblock %}