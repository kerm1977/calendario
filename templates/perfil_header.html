<!-- Librería para generar PDF en el cliente -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<div class="container py-5 animate__animated animate__fadeIn" id="perfilContainer">
    
    <!-- ENCABEZADO DE PERFIL -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- TARJETA DE IDENTIDAD DIGITAL -->
            <div class="card border-0 shadow-2xl rounded-5 overflow-hidden mb-4 bg-white text-dark position-relative" id="cardIdentidad">
                <!-- Fondo decorativo -->
                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(255,193,7,0.05) 0%, rgba(255,255,255,0) 100%); z-index: 0;"></div>
                
                <div class="card-body p-4 p-lg-5 position-relative" style="z-index: 1;">
                    <div class="row align-items-center">
                        <div class="col-md-8 mb-4 mb-md-0">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-25 text-warning p-3 rounded-circle me-3">
                                    <i class="bi {{ icono_nivel }} display-5"></i>
                                </div>
                                <div>
                                    <h6 class="text-uppercase fw-bold text-muted small mb-1">Pasaporte de Aventurero</h6>
                                    <h1 class="display-5 fw-bold mb-0" id="nombreMiembro">{{ member.nombre }} {{ member.apellido1 }}</h1>
                                    <span class="badge bg-light text-dark border mt-2">
                                        <i class="bi bi-star-fill text-warning me-1"></i> Rango: <span class="{{ clase_nivel }} fw-bold">{{ nivel }}</span>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- BARRA DE PROGRESO VIP -->
                            <div class="mt-3 pe-md-5 no-print">
                                <div class="d-flex justify-content-between small fw-bold text-uppercase mb-1">
                                    <span class="text-muted"><i class="bi bi-geo-alt-fill me-1"></i>{{ total_caminatas }} Expediciones</span>
                                    <span class="{{ 'text-warning' if total_caminatas > 15 else 'text-muted' }}">Meta VIP: 15</span>
                                </div>
                                <div class="progress rounded-pill" style="height: 10px; background-color: #e9ecef;">
                                    <div class="progress-bar {{ 'bg-warning progress-bar-striped progress-bar-animated' if total_caminatas > 15 else 'bg-success' }}" 
                                         role="progressbar" 
                                         style="width: {{ progreso_vip }}%" 
                                         aria-valuenow="{{ progreso_vip }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted fst-italic mt-1 d-block" style="font-size: 0.75rem;">
                                    {{ mensaje_prox_nivel }}
                                </small>
                            </div>
                            
                            <div class="row g-3 mt-3 align-items-center">
                                <div class="col-auto">
                                    <!-- SECCIÓN PIN CON BOTÓN DE EDICIÓN (ESTILO VERDE APLICADO) -->
                                    <div class="p-2 border border-success border-opacity-25 rounded-3 bg-success bg-opacity-10 position-relative pe-5 shadow-sm">
                                        <small class="d-block text-success fw-bold x-small text-uppercase opacity-75">PIN Único</small>
                                        <span class="fw-bold font-monospace fs-5 text-success">{{ member.pin }}</span>
                                        
                                        <!-- BOTÓN CAMBIAR PIN (Oculto al imprimir) -->
                                        <!-- Dispara el modal interno #changePinModal -->
                                        <button class="btn btn-sm btn-white border position-absolute top-50 end-0 translate-middle-y me-2 rounded-circle shadow-sm hover-scale no-print" style="width: 32px; height: 32px;" data-bs-toggle="modal" data-bs-target="#changePinModal" title="Personalizar PIN">
                                            <i class="bi bi-pencil-fill small text-success"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- ================================================================= -->
                                <!-- BLOQUE: GESTOR DE DEUDA -->
                                <!-- ================================================================= -->
                                {% if member.debt_pending or (current_user.is_authenticated and current_user.is_superuser) %}
                                <div class="col-auto" id="debtContainer">
                                    {% if member.debt_pending %}
                                        <!-- ESTADO: DEUDA PENDIENTE (ROJO - VISIBLE PARA TODOS) -->
                                        <div class="p-2 border border-danger border-opacity-25 rounded-3 bg-danger bg-opacity-10 text-danger shadow-sm d-flex align-items-center gap-2 animate__animated animate__fadeIn">
                                            <div class="lh-1">
                                                <small class="d-block fw-bold x-small text-uppercase opacity-75">Estado de Cuenta</small>
                                                <span class="fw-bold fs-6"><i class="bi bi-exclamation-circle-fill me-1"></i>Pendiente</span>
                                            </div>
                                            {% if current_user.is_authenticated and current_user.is_superuser %}
                                            <!-- BOTÓN CONFIRMADO (SOLO ADMIN): QUITA LA DEUDA -->
                                            <button onclick="toggleDebt({{ member.id }})" class="btn btn-sm btn-danger fw-bold rounded-pill ms-2 shadow-sm py-1 px-3" title="Marcar como pagado/confirmado">
                                                Confirmado
                                            </button>
                                            {% endif %}
                                        </div>
                                    {% elif current_user.is_authenticated and current_user.is_superuser %}
                                        <!-- ESTADO: AL DÍA (VERDE - SOLO VISIBLE PARA ADMIN) -->
                                        <div class="p-2 border border-success border-opacity-25 rounded-3 bg-success bg-opacity-10 text-success shadow-sm d-flex align-items-center gap-2 animate__animated animate__fadeIn opacity-75">
                                            <div class="lh-1">
                                                <small class="d-block fw-bold x-small text-uppercase opacity-75">Estado de Cuenta</small>
                                                <span class="fw-bold fs-6"><i class="bi bi-check-circle-fill me-1"></i>Al Día</span>
                                            </div>
                                            <!-- BOTÓN REVERTIR: VUELVE A PONER LA DEUDA -->
                                            <button onclick="toggleDebt({{ member.id }})" class="btn btn-sm btn-outline-success fw-bold rounded-circle ms-2 p-0 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;" title="Revertir a Pendiente">
                                                <i class="bi bi-arrow-counterclockwise" style="font-size: 0.8rem;"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                <!-- ================================================================= -->

                                <div class="col-auto">
                                    <!-- Fondo gris oscuro y texto blanco para teléfono -->
                                    <div class="p-2 border rounded-3 bg-dark text-white shadow-sm">
                                        <small class="d-block text-white-50 x-small text-uppercase">Teléfono</small>
                                        <span class="fw-bold">+506 {{ member.telefono }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-center text-md-end">
                            <div class="p-4 rounded-5 bg-success bg-opacity-10 border border-success border-opacity-25 d-inline-block w-100 position-relative">
                                <small class="text-uppercase fw-bold text-success opacity-75 d-block mb-1">Saldo Disponible</small>
                                <div class="display-3 fw-bold text-success mb-0" id="saldoActual">{{ member.puntos_totales }}</div>
                                <small class="text-success fw-medium">Puntos Canjeables</small>

                                <!-- ZONA ADMIN: SOLO VISIBLE PARA SUPERUSUARIOS -->
                                {% if current_user.is_authenticated and current_user.is_superuser %}
                                <div class="mt-3 border-top border-success border-opacity-25 pt-3 no-print">
                                    <button class="btn btn-dark w-100 rounded-pill fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#adminAdvancedModal">
                                        <i class="bi bi-shield-lock-fill me-2"></i>Admin: Gestión Saldo
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            