{% extends "base.html" %}

{% block title %}Mi Perfil - {{ member.nombre }}{% endblock %}

{% block content %}
<div class="container py-5 animate__animated animate__fadeIn">
    
    <!-- ENCABEZADO DE PERFIL -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- TARJETA DE IDENTIDAD DIGITAL -->
            <div class="card border-0 shadow-2xl rounded-5 overflow-hidden mb-4 bg-white text-dark position-relative">
                <!-- Fondo decorativo -->
                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(255,193,7,0.05) 0%, rgba(255,255,255,0) 100%); z-index: 0;"></div>
                
                <div class="card-body p-4 p-lg-5 position-relative" style="z-index: 1;">
                    <div class="row align-items-center">
                        <div class="col-md-8 mb-4 mb-md-0">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-25 text-warning p-3 rounded-circle me-3">
                                    <i class="bi {{ icono_nivel }} display-5"></i>
                                </div>
                                <div>
                                    <h6 class="text-uppercase fw-bold text-muted small mb-1">Pasaporte de Aventurero</h6>
                                    <h1 class="display-5 fw-bold mb-0">{{ member.nombre }} {{ member.apellido1 }}</h1>
                                    <span class="badge bg-light text-dark border mt-2">
                                        <i class="bi bi-star-fill text-warning me-1"></i> Rango: <span class="{{ clase_nivel }} fw-bold">{{ nivel }}</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-auto">
                                    <!-- SECCI√ìN PIN CON BOT√ìN DE EDICI√ìN -->
                                    <div class="p-2 border rounded-3 bg-light position-relative pe-5 shadow-sm">
                                        <small class="d-block text-muted x-small text-uppercase">PIN √önico</small>
                                        <span class="fw-bold font-monospace fs-5 text-primary">{{ member.pin }}</span>
                                        
                                        <!-- BOT√ìN CAMBIAR PIN -->
                                        <button class="btn btn-sm btn-white border position-absolute top-50 end-0 translate-middle-y me-2 rounded-circle shadow-sm hover-scale" style="width: 32px; height: 32px;" data-bs-toggle="modal" data-bs-target="#changePinModal" title="Personalizar PIN">
                                            <i class="bi bi-pencil-fill small text-muted"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="p-2 border rounded-3 bg-light">
                                        <small class="d-block text-muted x-small text-uppercase">Cumplea√±os</small>
                                        <span class="fw-bold">
                                            {% if member.birth_date %}
                                                {{ member.birth_date.strftime('%d de %B') }}
                                            {% else %}
                                                No registrado
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="p-2 border rounded-3 bg-light">
                                        <small class="d-block text-muted x-small text-uppercase">Tel√©fono</small>
                                        <span class="fw-bold">+506 {{ member.telefono }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-center text-md-end">
                            <div class="p-4 rounded-5 bg-success bg-opacity-10 border border-success border-opacity-25 d-inline-block w-100 position-relative">
                                <small class="text-uppercase fw-bold text-success opacity-75 d-block mb-1">Saldo Disponible</small>
                                <div class="display-3 fw-bold text-success mb-0">{{ member.puntos_totales }}</div>
                                <small class="text-success fw-medium">Puntos Canjeables</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================================== -->
            <!-- BARRA DE ACCIONES R√ÅPIDAS (DISTRIBUIDA) -->
            <!-- ========================================================== -->
            <div class="row g-3 mb-5">
                <!-- 1. Canjear Aventura -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-warning text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#redeemAdventureModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-white bg-opacity-25 p-3 rounded-circle mb-2 shadow-sm">
                                <i class="bi bi-ticket-detailed-fill fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Canjear Aventura</div>
                        </div>
                    </div>
                </div>
                <!-- 2. Canjear Items -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-white text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#redeemOtherModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-dark bg-opacity-10 p-3 rounded-circle mb-2 text-dark">
                                <i class="bi bi-bag-heart-fill fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Canjear Items</div>
                        </div>
                    </div>
                </div>
                <!-- 3. Comprar Puntos -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-white text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#buyPointsModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle mb-2 text-success">
                                <i class="bi bi-cash-coin fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Comprar Puntos</div>
                        </div>
                    </div>
                </div>
                <!-- 4. Regalo Cumple -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-white text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#giftBirthdayModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle mb-2 text-primary">
                                <i class="bi bi-gift-fill fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Regalo Cumple</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- COLUMNA IZQUIERDA: PR√ìXIMAS AVENTURAS -->
                <div class="col-md-5">
                    <h5 class="fw-bold mb-4 ps-2 border-start border-4 border-warning">Mis Pr√≥ximas Rutas</h5>
                    {% if proximas %}
                        {% for booking in proximas %}
                        <div class="card border-0 shadow-sm rounded-4 mb-3 overflow-hidden">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-warning bg-opacity-10 p-3 rounded-3 text-warning">
                                        <i class="bi bi-calendar-event fs-4"></i>
                                    </div>
                                    <div class="ms-3 overflow-hidden">
                                        <h6 class="fw-bold mb-1 text-truncate">{{ booking.event.title }}</h6>
                                        <small class="text-muted d-block">
                                            <i class="bi bi-clock me-1"></i>{{ booking.event.event_date.strftime('%d/%m/%Y') }}
                                        </small>
                                        <small class="text-success fw-bold">
                                            <i class="bi bi-check-circle me-1"></i>Cupo Confirmado
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5 bg-light rounded-4 border border-dashed">
                            <i class="bi bi-backpack text-muted opacity-25 display-4 mb-3 d-block"></i>
                            <p class="text-muted small mb-0">No tienes expediciones activas.</p>
                            <a href="{{ url_for('main.home') }}" class="btn btn-sm btn-link text-warning fw-bold text-decoration-none">Ver Calendario</a>
                        </div>
                    {% endif %}
                </div>

                <!-- COLUMNA DERECHA: HISTORIAL DE PUNTOS -->
                <div class="col-md-7">
                    <h5 class="fw-bold mb-4 ps-2 border-start border-4 border-secondary">Historial de Movimientos</h5>
                    
                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="list-group list-group-flush">
                            {% if logs %}
                                {% for log in logs %}
                                <div class="list-group-item p-3 border-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <!-- L√ìGICA DE ICONOS ACTUALIZADA -->
                                                {% if 'Canje' in log.transaction_type %}
                                                    <i class="bi bi-shop text-danger fs-4" title="Canje Realizado"></i>
                                                {% elif log.transaction_type == 'Bono Cumplea√±os' %}
                                                    <i class="bi bi-gift-fill text-primary fs-4" title="Regalo de Cumplea√±os"></i>
                                                {% elif log.transaction_type == 'Compra Puntos' %}
                                                    <i class="bi bi-cash-coin text-success fs-4" title="Compra de Puntos"></i>
                                                {% elif 'Inscripci√≥n' in log.transaction_type or 'Bienvenida' in log.transaction_type %}
                                                    <i class="bi bi-arrow-up-circle-fill text-success fs-4" title="Puntos Ganados"></i>
                                                {% elif 'Retiro' in log.transaction_type or 'Penalizaci√≥n' in log.transaction_type %}
                                                    <i class="bi bi-x-circle-fill text-danger fs-4" title="Deducci√≥n"></i>
                                                {% elif log.amount > 0 %}
                                                    <i class="bi bi-plus-circle-fill text-success fs-4"></i>
                                                {% else %}
                                                    <i class="bi bi-dash-circle-fill text-danger fs-4"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark small">{{ log.description }}</div>
                                                <small class="text-muted x-small">
                                                    {{ log.created_at.strftime('%d/%m/%Y') }} 
                                                    <span class="text-uppercase ms-1 opacity-75" style="font-size: 0.65rem;">{{ log.transaction_type }}</span>
                                                </small>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="fw-bold fs-6 {{ 'text-success' if log.amount > 0 else 'text-danger' }}">
                                                {{ '+' if log.amount > 0 }}{{ log.amount }} pts
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="p-4 text-center text-muted small">
                                    A√∫n no hay movimientos registrados.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5">
                <a href="{{ url_for('main.home') }}" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">
                    <i class="bi bi-arrow-left me-2"></i>Volver al Inicio
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================== -->
<!-- MODALES DE GESTI√ìN -->
<!-- ============================================================== -->

<!-- NUEVO: MODAL PARA CAMBIAR PIN -->
<div class="modal fade" id="changePinModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('perfil.cambiar_pin') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-key-fill me-2"></i>Personalizar PIN</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <label class="form-label x-small fw-bold text-uppercase text-secondary">Nuevo PIN (6-8 caracteres)</label>
                    <input type="text" name="nuevo_pin" class="form-control form-control-lg text-center fw-bold border-primary text-primary text-uppercase" placeholder="ALFA123" minlength="6" maxlength="8" required oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                    <small class="text-muted d-block mt-2 x-small lh-sm">
                        Solo letras y n√∫meros. Debe ser √∫nico en La Tribu.
                    </small>
                </div>
                <div class="alert alert-warning x-small border-0 py-2 mb-0">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> ¬°No lo olvides! Lo necesitar√°s para entrar.
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary fw-bold rounded-pill shadow-sm">GUARDAR PIN</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 1. CANJEAR AVENTURA -->
<div class="modal fade" id="redeemAdventureModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('puntos.canjear_aventura') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-warning text-dark border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-ticket-detailed me-2"></i>Canjear Aventura</h6>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                {% if member.puntos_totales >= 5000 %}
                    <div class="alert alert-success border-0 small py-2 mb-3">
                        <i class="bi bi-check-circle-fill me-1"></i> Saldo disponible para canje (>5,000 pts).
                    </div>
                    <div class="mb-3">
                        <label class="form-label x-small fw-bold text-uppercase">Selecciona Aventura Activa</label>
                        <select name="event_id" class="form-select border-warning shadow-none mb-2" required>
                            <option value="" disabled selected>Seleccione una ruta...</option>
                            {% if eventos_activos %}
                                {% for ev in eventos_activos %}
                                <option value="{{ ev.id }}">{{ ev.title }} ({{ ev.event_date }})</option>
                                {% endfor %}
                            {% else %}
                                <option disabled>Cargando lista o no disponible...</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label x-small fw-bold text-uppercase">Puntos a Descontar</label>
                        <input type="number" name="costo_puntos" class="form-control form-control-lg text-center fw-bold border-warning text-danger" placeholder="Ej: 5000" min="1" max="{{ member.puntos_totales }}" required>
                        <small class="text-muted d-block mt-1 x-small">Este monto se restar√° del saldo del miembro.</small>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-warning fw-bold rounded-pill shadow-sm text-dark">CONFIRMAR CANJE</button>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-lock-fill text-muted display-4 opacity-25 mb-3 d-block"></i>
                        <h5 class="fw-bold text-danger">Saldo Insuficiente</h5>
                        <p class="text-muted small">Necesitas un m√≠nimo de <strong>5,000 puntos</strong> para habilitar los canjes de aventuras.</p>
                        <button type="button" class="btn btn-light rounded-pill border fw-bold px-4 mt-2" data-bs-dismiss="modal">Entendido</button>
                    </div>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- 2. CANJEAR OTRO -->
<div class="modal fade" id="redeemOtherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('puntos.canjear_otro') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-dark text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-bag-heart me-2"></i>Canjear Art√≠culo/Otro</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3 text-start">
                    <label class="form-label x-small fw-bold text-uppercase">Descripci√≥n del Canje</label>
                    <input type="text" name="descripcion" class="form-control shadow-none" placeholder="Ej: Camiseta Oficial, Fiesta Fin de A√±o..." required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label x-small fw-bold text-uppercase">Costo en Puntos</label>
                    <input type="number" name="costo_puntos" class="form-control form-control-lg text-center fw-bold border-dark text-danger" placeholder="0" min="1" max="{{ member.puntos_totales }}" required>
                </div>
                {% if member.puntos_totales < 5000 %}
                <div class="alert alert-warning border-0 x-small py-2 mb-0">
                    <i class="bi bi-exclamation-triangle me-1"></i> Advertencia: Saldo menor a 5,000 pts.
                </div>
                {% endif %}
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-dark fw-bold rounded-pill shadow-sm">APLICAR CANJE</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 3. COMPRAR PUNTOS -->
<div class="modal fade" id="buyPointsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('puntos.comprar_puntos') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-success text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-cash-coin me-2"></i>Comprar Puntos</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="text-success mb-3 opacity-25">
                    <i class="bi bi-coin display-3"></i>
                </div>
                <div class="mb-3">
                    <label class="form-label x-small fw-bold text-uppercase text-success">Cantidad a Comprar</label>
                    <input type="number" name="cantidad" class="form-control form-control-lg text-center fw-bold border-success text-success" placeholder="1000" min="1000" max="10000" step="100" required>
                    <small class="text-muted d-block mt-1 x-small">Rango permitido: 1,000 - 10,000 pts</small>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-success fw-bold rounded-pill shadow-sm">ACREDITAR PUNTOS</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 4. REGALO CUMPLEA√ëOS -->
<div class="modal fade" id="giftBirthdayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('puntos.obsequiar_cumple') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-gift-fill me-2"></i>Regalo Cumplea√±os</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                {% if member.birth_date and member.birth_date.month == now.month and member.birth_date.day == now.day %}
                    <div class="text-primary mb-3 animate__animated animate__heartBeat animate__infinite">
                        <i class="bi bi-cake2-fill display-3"></i>
                    </div>
                    <h6 class="fw-bold text-primary mb-3">¬°Hoy es su cumplea√±os! üéâ</h6>
                    <div class="mb-3">
                        <label class="form-label x-small fw-bold text-uppercase text-primary">Monto del Obsequio</label>
                        <input type="number" name="cantidad" class="form-control form-control-lg text-center fw-bold border-primary text-primary" placeholder="500" min="250" max="1000" required>
                        <small class="text-muted d-block mt-1 x-small">Permitido: 250 - 1,000 pts</small>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary fw-bold rounded-pill shadow-sm">ENVIAR REGALO</button>
                    </div>
                {% else %}
                    <div class="text-muted mb-3 opacity-25">
                        <i class="bi bi-calendar-x display-3"></i>
                    </div>
                    <h6 class="fw-bold text-secondary mb-2">No es su cumplea√±os hoy.</h6>
                    <p class="small text-muted mb-3">
                        Fecha registrada: 
                        <strong>
                            {% if member.birth_date %}
                                {{ member.birth_date.strftime('%d de %B') }}
                            {% else %}
                                No registrada
                            {% endif %}
                        </strong>
                    </p>
                    <div class="alert alert-warning x-small border-0 py-2">
                        <i class="bi bi-info-circle me-1"></i> Solo se puede obsequiar el propio d√≠a del evento.
                    </div>
                    <button type="button" class="btn btn-light rounded-pill border w-100 fw-bold" data-bs-dismiss="modal">Cerrar</button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<style>
    .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
    .x-small { font-size: 0.7rem; }
    .transition-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .transition-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
    .hover-scale:hover { transform: scale(1.1); transition: transform 0.2s; }
    .cursor-pointer { cursor: pointer; }
    
    /* Ajuste de degradado para modo oscuro si lo usas */
    [data-bs-theme="dark"] .bg-white { background-color: #212529 !important; }
    [data-bs-theme="dark"] .text-dark { color: #f8f9fa !important; }
    [data-bs-theme="dark"] .list-group-item { background-color: #212529; border-color: #333; }
</style>
{% endblock %}