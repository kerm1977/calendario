{% extends "base.html" %}

{% block title %}Mi Perfil - {{ member.nombre }}{% endblock %}

{% block content %}
<div class="container py-5 animate__animated animate__fadeIn">
    
    <!-- ENCABEZADO DE PERFIL -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- TARJETA DE IDENTIDAD DIGITAL -->
            <div class="card border-0 shadow-2xl rounded-5 overflow-hidden mb-4 bg-white text-dark position-relative">
                <!-- Fondo decorativo -->
                <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(255,193,7,0.05) 0%, rgba(255,255,255,0) 100%); z-index: 0;"></div>
                
                <div class="card-body p-4 p-lg-5 position-relative" style="z-index: 1;">
                    <div class="row align-items-center">
                        <div class="col-md-8 mb-4 mb-md-0">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-25 text-warning p-3 rounded-circle me-3">
                                    <i class="bi {{ icono_nivel }} display-5"></i>
                                </div>
                                <div>
                                    <h6 class="text-uppercase fw-bold text-muted small mb-1">Pasaporte de Aventurero</h6>
                                    <h1 class="display-5 fw-bold mb-0">{{ member.nombre }} {{ member.apellido1 }}</h1>
                                    <span class="badge bg-light text-dark border mt-2">
                                        <i class="bi bi-star-fill text-warning me-1"></i> Rango: <span class="{{ clase_nivel }} fw-bold">{{ nivel }}</span>
                                    </span>
                                </div>
                            </div>
                            
                            <!-- BARRA DE PROGRESO VIP (NUEVO) -->
                            <div class="mt-3 pe-md-5">
                                <div class="d-flex justify-content-between small fw-bold text-uppercase mb-1">
                                    <span class="text-muted"><i class="bi bi-geo-alt-fill me-1"></i>{{ total_caminatas }} Expediciones</span>
                                    <span class="{{ 'text-warning' if total_caminatas > 15 else 'text-muted' }}">Meta VIP: 15</span>
                                </div>
                                <div class="progress rounded-pill" style="height: 10px; background-color: #e9ecef;">
                                    <div class="progress-bar {{ 'bg-warning progress-bar-striped progress-bar-animated' if total_caminatas > 15 else 'bg-success' }}" 
                                         role="progressbar" 
                                         style="width: {{ progreso_vip }}%" 
                                         aria-valuenow="{{ progreso_vip }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted fst-italic mt-1 d-block" style="font-size: 0.75rem;">
                                    {{ mensaje_prox_nivel }}
                                </small>
                            </div>
                            
                            <div class="row g-3 mt-3">
                                <div class="col-auto">
                                    <!-- SECCIÓN PIN CON BOTÓN DE EDICIÓN -->
                                    <div class="p-2 border rounded-3 bg-light position-relative pe-5 shadow-sm">
                                        <small class="d-block text-muted x-small text-uppercase">PIN Único</small>
                                        <span class="fw-bold font-monospace fs-5 text-primary">{{ member.pin }}</span>
                                        
                                        <!-- BOTÓN CAMBIAR PIN -->
                                        <button class="btn btn-sm btn-white border position-absolute top-50 end-0 translate-middle-y me-2 rounded-circle shadow-sm hover-scale" style="width: 32px; height: 32px;" data-bs-toggle="modal" data-bs-target="#changePinModal" title="Personalizar PIN">
                                            <i class="bi bi-pencil-fill small text-muted"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="p-2 border rounded-3 bg-light">
                                        <small class="d-block text-muted x-small text-uppercase">Teléfono</small>
                                        <span class="fw-bold">+506 {{ member.telefono }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-center text-md-end">
                            <div class="p-4 rounded-5 bg-success bg-opacity-10 border border-success border-opacity-25 d-inline-block w-100 position-relative">
                                <small class="text-uppercase fw-bold text-success opacity-75 d-block mb-1">Saldo Disponible</small>
                                <div class="display-3 fw-bold text-success mb-0">{{ member.puntos_totales }}</div>
                                <small class="text-success fw-medium">Puntos Canjeables</small>

                                <!-- ZONA ADMIN: SOLO VISIBLE PARA SUPERUSUARIOS -->
                                {% if current_user.is_authenticated and current_user.is_superuser %}
                                <div class="mt-3 border-top border-success border-opacity-25 pt-3">
                                    <button class="btn btn-dark w-100 rounded-pill fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#adminAdvancedModal">
                                        <i class="bi bi-shield-lock-fill me-2"></i>Admin: Gestión Saldo
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================================== -->
            <!-- RESUMEN DE VENCIMIENTO (VISUALIZACIÓN RÁPIDA) -->
            <!-- ========================================================== -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                <div class="card-body p-4 
                    {% if vencimiento.vencido %}bg-danger bg-opacity-10
                    {% elif vencimiento.dias_restantes < 60 %}bg-warning bg-opacity-10
                    {% else %}bg-info bg-opacity-10{% endif %}">
                    
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                        <div class="d-flex align-items-center">
                            <div class="p-3 rounded-circle me-3 bg-white bg-opacity-50 text-dark shadow-sm">
                                <i class="bi bi-hourglass-split fs-3"></i>
                            </div>
                            <div>
                                <h6 class="fw-bold mb-1 
                                    {% if vencimiento.vencido %}text-danger{% elif vencimiento.dias_restantes < 60 %}text-warning-emphasis{% else %}text-info-emphasis{% endif %}">
                                    Ciclo de Vigencia de Puntos
                                </h6>
                                <p class="small mb-0 text-muted" style="line-height: 1.4;">
                                    Tus puntos tienen una validez de <strong>1 año (365 días)</strong>.<br>
                                    Consulta abajo las políticas detalladas de uso y penalización.
                                </p>
                            </div>
                        </div>
                        
                        <div class="text-center bg-white p-3 rounded-4 shadow-sm border border-opacity-10 w-100 w-md-auto
                            {% if vencimiento.vencido %}border-danger{% elif vencimiento.dias_restantes < 60 %}border-warning{% else %}border-info{% endif %}">
                            <small class="text-uppercase fw-bold x-small text-muted d-block mb-1">Días para renovar/usar</small>
                            
                            {% if vencimiento.vencido %}
                                <div class="text-danger fw-bold fs-4">¡PUNTOS VENCIDOS!</div>
                                <small class="text-danger fw-bold d-block">Penalización del 25% aplicable</small>
                            {% else %}
                                <div class="fw-bold fs-2 
                                    {% if vencimiento.dias_restantes < 60 %}text-warning{% else %}text-info{% endif %}">
                                    {{ vencimiento.dias_restantes }} <span class="fs-6 text-muted">días</span>
                                </div>
                                <small class="text-muted d-block">Vence: {{ vencimiento.fecha_limite.strftime('%d/%m/%Y') }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================================== -->
            <!-- NUEVA SECCIÓN: POLÍTICAS Y NORMATIVAS DETALLADAS -->
            <!-- ========================================================== -->
            <div class="accordion shadow-sm rounded-4 mb-5 border-0" id="policiesAccordion">
                <div class="accordion-item border-0 rounded-4 overflow-hidden">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-white fw-bold text-dark py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePolicies">
                            <i class="bi bi-file-earmark-text-fill text-warning me-2"></i>
                            Normativa Institucional y Políticas de Uso
                        </button>
                    </h2>
                    <div id="collapsePolicies" class="accordion-collapse collapse" data-bs-parent="#policiesAccordion">
                        <div class="accordion-body bg-light p-4">
                            <div class="row g-4">
                                <!-- Columna 1: Intercambio y Gestión -->
                                <div class="col-md-6 border-end-md">
                                    <h6 class="fw-bold text-uppercase x-small text-secondary mb-3 pb-2 border-bottom">
                                        <i class="bi bi-arrow-left-right me-2"></i>Intercambio y Adquisición
                                    </h6>
                                    
                                    <ul class="list-unstyled small text-secondary mb-0">
                                        <li class="mb-3">
                                            <strong class="text-dark d-block">Actividades de Senderismo y Expediciones</strong>
                                            Los puntos acumulados poseen una aplicabilidad del <span class="text-success fw-bold">100%</span> para cubrir el costo total de las caminatas y eventos oficiales.
                                        </li>
                                        <li class="mb-3">
                                            <strong class="text-dark d-block">Artículos Institucionales (Merch)</strong>
                                            El canje por mercadería oficial (camisetas, pines, bandanas, etc.) se realiza por el <span class="text-success fw-bold">100%</span> del valor en puntos.
                                        </li>
                                        <li class="mb-3">
                                            <strong class="text-dark d-block">Adquisición (Compra) de Puntos</strong>
                                            En la compra de paquetes de puntos, se destina un <span class="text-dark fw-bold">5%</span> del valor transaccional al fondo de mantenimiento tecnológico, renovación de dominio y hosting de La Tribu.
                                        </li>
                                        <li>
                                            <strong class="text-dark d-block">Donaciones y Solidaridad Externa</strong>
                                            Las transferencias destinadas a obras benéficas (ej. Teletón) se aplican íntegramente (<span class="text-success fw-bold">100%</span>) a favor de la institución beneficiaria. <em class="d-block mt-1 x-small text-muted">*Toda donación es irrevocable; no se admiten solicitudes de reintegro.</em>
                                        </li>
                                    </ul>
                                </div>

                                <!-- Columna 2: Penalizaciones y Normativa -->
                                <div class="col-md-6">
                                    <h6 class="fw-bold text-uppercase x-small text-secondary mb-3 pb-2 border-bottom">
                                        <i class="bi bi-exclamation-triangle me-2"></i>Régimen de Penalizaciones
                                    </h6>
                                    
                                    <ul class="list-unstyled small text-secondary mb-0">
                                        <li class="mb-3">
                                            <strong class="text-dark d-block text-danger">Política de Cancelación Tardía (< 10 días)</strong>
                                            El retiro de un evento con menos de 10 días de antelación conlleva una doble penalización:
                                            <ul class="mt-1 ps-3">
                                                <li>No se devengan los puntos potenciales del evento.</li>
                                                <li>Se deduce del saldo actual una cantidad equivalente a los puntos que se habrían obtenido.</li>
                                            </ul>
                                        </li>
                                        <li class="mb-3">
                                            <strong class="text-dark d-block">Inactividad y Vencimiento Anual</strong>
                                            Los puntos tienen una vigencia de 365 días desde el registro. La falta de uso tras este periodo implica una penalización del <span class="text-danger fw-bold">25%</span> sobre el saldo, destinada al mantenimiento de la plataforma.
                                        </li>
                                        <li class="mb-3">
                                            <strong class="text-dark d-block">Retiro Voluntario del Programa</strong>
                                            En caso de solicitar la liquidación en efectivo por retiro definitivo del plan, se aplicará una retención del <span class="text-danger fw-bold">25%</span> por gastos administrativos.
                                        </li>
                                        <li>
                                            <strong class="text-dark d-block">Obsequios entre Miembros</strong>
                                            Los puntos regalados por cumpleaños se acreditan al <span class="text-success fw-bold">100%</span> al beneficiario, libres de costos para La Tribu.
                                        </li>
                                    </ul>
                                </div>
                                
                                <!-- Sección Completa: Excepciones (Fondo Gris) -->
                                <div class="col-12 mt-2">
                                    <div class="bg-white p-3 rounded-3 border border-secondary border-opacity-25">
                                        <h6 class="fw-bold text-uppercase x-small text-dark mb-2">
                                            <i class="bi bi-shield-check me-2 text-success"></i>Excepciones de Fuerza Mayor (Liquidación en Efectivo)
                                        </h6>
                                        <p class="small text-muted mb-2">
                                            En situaciones especiales comprobadas, se autoriza el reintegro en efectivo bajo las siguientes condiciones:
                                        </p>
                                        <div class="row g-3 small">
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-start">
                                                    <i class="bi bi-heart-pulse-fill text-danger me-2 mt-1"></i>
                                                    <div>
                                                        <span class="fw-bold d-block">Fallecimiento de Familiar (1° Grado)</span>
                                                        <span>Se reintegra el 90% del valor. El 10% restante se destina al fondo de mantenimiento.</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="d-flex align-items-start">
                                                    <i class="bi bi-bandaid-fill text-danger me-2 mt-1"></i>
                                                    <div>
                                                        <span class="fw-bold d-block">Lesión con Epicrisis Médica</span>
                                                        <span>Se reintegra el 90% del valor. El 10% restante cubre costos operativos de La Tribu.</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================================== -->
            <!-- BARRA DE ACCIONES RÁPIDAS (DISTRIBUIDA) -->
            <!-- ========================================================== -->
            <div class="row g-3 mb-5">
                <!-- 1. Canjear Aventura -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-warning text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#redeemAdventureModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-white bg-opacity-25 p-3 rounded-circle mb-2 shadow-sm">
                                <i class="bi bi-ticket-detailed-fill fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Canjear Aventura</div>
                        </div>
                    </div>
                </div>
                <!-- 2. Canjear Items -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-white text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#redeemOtherModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-dark bg-opacity-10 p-3 rounded-circle mb-2 text-dark">
                                <i class="bi bi-bag-heart-fill fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Canjear Items</div>
                        </div>
                    </div>
                </div>
                <!-- 3. Comprar Puntos -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-white text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#buyPointsModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-success bg-opacity-10 p-3 rounded-circle mb-2 text-success">
                                <i class="bi bi-cash-coin fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Comprar Puntos</div>
                        </div>
                    </div>
                </div>
                <!-- 4. Regalo Cumple (MODIFICADO PARA ENVIAR A OTROS) -->
                <div class="col-6 col-lg-3">
                    <div class="card border-0 shadow-sm rounded-4 h-100 bg-white text-dark text-center cursor-pointer transition-hover" data-bs-toggle="modal" data-bs-target="#giftBirthdayModal" role="button">
                        <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center">
                            <div class="bg-primary bg-opacity-10 p-3 rounded-circle mb-2 text-primary">
                                <i class="bi bi-gift-fill fs-3"></i>
                            </div>
                            <div class="fw-bold small text-uppercase">Enviar Regalo</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================================== -->
            <!-- NUEVA INTEGRACIÓN: TARJETA DE EVENTOS CANCELADOS Y PENALIZACIONES -->
            <!-- ============================================================================== -->
            {% if eventos_cancelados %}
            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden animate__animated animate__fadeInUp">
                <div class="card-header bg-danger text-white p-3 border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold text-uppercase"><i class="bi bi-x-octagon-fill me-2"></i>Eventos Cancelados / Penalizaciones</h6>
                        <span class="badge bg-white text-danger rounded-pill px-3">{{ eventos_cancelados|length }}</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 text-secondary small fw-bold text-uppercase">Fecha</th>
                                    <th class="text-secondary small fw-bold text-uppercase">Aventura</th>
                                    <th class="text-secondary small fw-bold text-uppercase">Estado</th>
                                    <th class="text-end pe-4 text-secondary small fw-bold text-uppercase">Penalización</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in eventos_cancelados %}
                                <tr>
                                    <td class="ps-4 text-muted small">{{ booking.event.event_date.strftime('%d/%m/%Y') }}</td>
                                    <td class="fw-bold text-dark">{{ booking.event.title }}</td>
                                    <td>
                                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                                            {{ booking.status }}
                                        </span>
                                    </td>
                                    <td class="text-end pe-4">
                                        {% if booking.monto_penalizacion > 0 %}
                                            <span class="text-danger fw-bold">-{{ booking.monto_penalizacion }} pts</span>
                                        {% else %}
                                            <span class="text-muted small">--</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- FIN DE INTEGRACIÓN -->

            <div class="row g-4">
                <!-- COLUMNA IZQUIERDA: PRÓXIMAS AVENTURAS -->
                <div class="col-md-5">
                    <h5 class="fw-bold mb-4 ps-2 border-start border-4 border-warning">Mis Próximas Rutas</h5>
                    {% if proximas %}
                        {% for booking in proximas %}
                        <!-- CAMBIO: Borde sólido visible para diferenciar -->
                        <div class="card border border-secondary border-opacity-25 shadow-sm rounded-4 mb-3 overflow-hidden">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0 bg-warning bg-opacity-10 p-3 rounded-3 text-warning">
                                        <i class="bi bi-calendar-event fs-4"></i>
                                    </div>
                                    <div class="ms-3 overflow-hidden w-100">
                                        <h6 class="fw-bold mb-1 text-truncate">{{ booking.event.title }}</h6>
                                        <!-- CAMBIO: Mostrar Distancia -->
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-clock me-1"></i>{{ booking.event.event_date.strftime('%d/%m/%Y') }}
                                            </small>
                                            <span class="badge bg-light text-dark border fw-bold text-truncate" style="max-width: 100px;">
                                                <i class="bi bi-signpost-split me-1 text-warning"></i>{{ booking.event.distance or 'N/A' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5 bg-light rounded-4 border border-dashed">
                            <i class="bi bi-backpack text-muted opacity-25 display-4 mb-3 d-block"></i>
                            <p class="text-muted small mb-0">No tienes expediciones activas.</p>
                            <a href="{{ url_for('main.home') }}" class="btn btn-sm btn-link text-warning fw-bold text-decoration-none">Ver Calendario</a>
                        </div>
                    {% endif %}
                </div>

                <!-- COLUMNA DERECHA: HISTORIAL DE PUNTOS -->
                <div class="col-md-7">
                    <h5 class="fw-bold mb-4 ps-2 border-start border-4 border-secondary">Historial de Movimientos</h5>
                    
                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                        <div class="list-group list-group-flush">
                            {% if logs %}
                                {% for log in logs %}
                                <div class="list-group-item p-3 border-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <!-- LÓGICA DE ICONOS ACTUALIZADA -->
                                                {% if 'Restitución Admin' in log.transaction_type %}
                                                    <i class="bi bi-arrow-counterclockwise text-primary fs-4" title="Restitución"></i>
                                                {% elif 'Donación Admin' in log.transaction_type %}
                                                    <i class="bi bi-gift-fill text-success fs-4" title="Donación Admin"></i>
                                                {% elif 'Penalización Admin' in log.transaction_type %}
                                                    <i class="bi bi-exclamation-triangle-fill text-danger fs-4" title="Eliminación Admin"></i>
                                                {% elif 'Canje' in log.transaction_type %}
                                                    <i class="bi bi-shop text-danger fs-4" title="Canje Realizado"></i>
                                                {% elif log.transaction_type == 'Bono Cumpleaños' %}
                                                    <i class="bi bi-gift-fill text-primary fs-4" title="Regalo de Cumpleaños"></i>
                                                {% elif log.transaction_type == 'Regalo Recibido' %}
                                                    <i class="bi bi-gift-fill text-primary fs-4" title="Regalo de un Amigo"></i>
                                                {% elif log.transaction_type == 'Regalo Enviado' %}
                                                    <i class="bi bi-send-fill text-warning fs-4" title="Regalo Enviado"></i>
                                                {% elif log.transaction_type == 'Compra Puntos' %}
                                                    <i class="bi bi-cash-coin text-success fs-4" title="Compra de Puntos"></i>
                                                {% elif 'Inscripción' in log.transaction_type or 'Bienvenida' in log.transaction_type %}
                                                    <i class="bi bi-arrow-up-circle-fill text-success fs-4" title="Puntos Ganados"></i>
                                                {% elif 'Retiro' in log.transaction_type or 'Penalización' in log.transaction_type %}
                                                    <i class="bi bi-x-circle-fill text-danger fs-4" title="Deducción"></i>
                                                {% elif log.amount > 0 %}
                                                    <i class="bi bi-plus-circle-fill text-success fs-4"></i>
                                                {% else %}
                                                    <i class="bi bi-dash-circle-fill text-danger fs-4"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark small">{{ log.description }}</div>
                                                <small class="text-muted x-small">
                                                    {{ log.created_at.strftime('%d/%m/%Y') }} 
                                                    <span class="text-uppercase ms-1 opacity-75" style="font-size: 0.65rem;">{{ log.transaction_type }}</span>
                                                </small>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="fw-bold fs-6 {{ 'text-success' if log.amount > 0 else 'text-danger' }}">
                                                {{ '+' if log.amount > 0 }}{{ log.amount }} pts
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="p-4 text-center text-muted small">
                                    Aún no hay movimientos registrados.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-5">
                <a href="{{ url_for('main.home') }}" class="btn btn-outline-secondary rounded-pill px-4 fw-bold">
                    <i class="bi bi-arrow-left me-2"></i>Volver al Inicio
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================== -->
<!-- MODALES DE GESTIÓN -->
<!-- ============================================================== -->

<!-- NUEVO: MODAL DE GESTIÓN AVANZADA DE PUNTOS (SOLO ADMIN) -->
{% if current_user.is_authenticated and current_user.is_superuser %}
<div class="modal fade" id="adminAdvancedModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-5 overflow-hidden">
            <div class="modal-header bg-dark text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-sliders me-2"></i>SuperAdmin: Gestión de Saldo</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <!-- TABS DE NAVEGACIÓN -->
                <ul class="nav nav-pills nav-fill p-3 gap-2 bg-light border-bottom" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active small fw-bold rounded-pill" id="pills-restore-tab" data-bs-toggle="pill" data-bs-target="#pills-restore" type="button" role="tab"><i class="bi bi-arrow-counterclockwise me-1"></i>Restituir</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link small fw-bold rounded-pill" id="pills-donate-tab" data-bs-toggle="pill" data-bs-target="#pills-donate" type="button" role="tab"><i class="bi bi-gift me-1"></i>Donar</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link small fw-bold rounded-pill text-danger" id="pills-remove-tab" data-bs-toggle="pill" data-bs-target="#pills-remove" type="button" role="tab"><i class="bi bi-trash me-1"></i>Eliminar</button>
                    </li>
                </ul>

                <div class="tab-content p-4" id="pills-tabContent">
                    
                    <!-- TAB 1: RESTITUIR (Añadir puntos perdidos) -->
                    <div class="tab-pane fade show active" id="pills-restore" role="tabpanel">
                        <form action="{{ url_for('perfil.admin_ajuste_saldo') }}" method="POST">
                            <input type="hidden" name="member_id" value="{{ member.id }}">
                            <input type="hidden" name="action_type" value="restituir">
                            <div class="text-center mb-3">
                                <div class="text-primary mb-2 opacity-50"><i class="bi bi-arrow-counterclockwise display-4"></i></div>
                                <p class="small text-muted">Devolver puntos perdidos por error o cancelaciones.</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label x-small fw-bold text-uppercase">Puntos a Restituir (+)</label>
                                <input type="number" name="amount" class="form-control form-control-lg text-center fw-bold border-primary text-primary" placeholder="0" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label x-small fw-bold text-uppercase">Motivo</label>
                                <input type="text" name="reason" class="form-control" placeholder="Ej: Error en registro anterior" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary fw-bold rounded-pill py-2 shadow-sm">CONFIRMAR RESTITUCIÓN</button>
                            </div>
                        </form>
                    </div>

                    <!-- TAB 2: DONAR (Regalo de Admin) -->
                    <div class="tab-pane fade" id="pills-donate" role="tabpanel">
                        <form action="{{ url_for('perfil.admin_ajuste_saldo') }}" method="POST">
                            <input type="hidden" name="member_id" value="{{ member.id }}">
                            <input type="hidden" name="action_type" value="donar">
                            <div class="text-center mb-3">
                                <div class="text-success mb-2 opacity-50"><i class="bi bi-gift display-4"></i></div>
                                <p class="small text-muted">Otorgar bonos especiales o premios de la casa.</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label x-small fw-bold text-uppercase text-success">Puntos a Donar (+)</label>
                                <input type="number" name="amount" class="form-control form-control-lg text-center fw-bold border-success text-success" placeholder="0" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label x-small fw-bold text-uppercase">Motivo del Regalo</label>
                                <input type="text" name="reason" class="form-control" placeholder="Ej: Premio Concurso Fotografía" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success fw-bold rounded-pill py-2 shadow-sm">ENVIAR DONACIÓN</button>
                            </div>
                        </form>
                    </div>

                    <!-- TAB 3: ELIMINAR (CON 3 PASOS DE SEGURIDAD) -->
                    <div class="tab-pane fade" id="pills-remove" role="tabpanel">
                        <form action="{{ url_for('perfil.admin_ajuste_saldo') }}" method="POST" id="formDeletePoints">
                            <input type="hidden" name="member_id" value="{{ member.id }}">
                            <input type="hidden" name="action_type" value="eliminar">
                            
                            <div class="text-center mb-3">
                                <div class="text-danger mb-2 opacity-50"><i class="bi bi-dash-circle display-4"></i></div>
                                <p class="small text-muted fw-bold text-danger">Zona de Peligro: Deducción de Saldo</p>
                            </div>

                            <div class="mb-3">
                                <label class="form-label x-small fw-bold text-uppercase text-danger">Puntos a Eliminar (-)</label>
                                <input type="number" name="amount" class="form-control form-control-lg text-center fw-bold border-danger text-danger" placeholder="0" min="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label x-small fw-bold text-uppercase">Justificación (Obligatoria)</label>
                                <input type="text" name="reason" class="form-control border-danger" placeholder="Ej: Penalización por inasistencia" required>
                            </div>

                            <!-- CONFIRMACIÓN DE 3 PASOS -->
                            <div class="bg-danger bg-opacity-10 p-3 rounded-3 border border-danger border-opacity-25 mb-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input border-danger" type="checkbox" id="step1_del" onchange="checkDeleteSteps()">
                                    <label class="form-check-label x-small fw-bold text-dark" for="step1_del">1. Entiendo que esto reducirá el saldo permanentemente.</label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input border-danger" type="checkbox" id="step2_del" onchange="checkDeleteSteps()">
                                    <label class="form-check-label x-small fw-bold text-dark" for="step2_del">2. He verificado el monto y el usuario.</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input border-danger" type="checkbox" id="step3_del" onchange="checkDeleteSteps()">
                                    <label class="form-check-label x-small fw-bold text-dark" for="step3_del">3. Confirmo esta acción administrativa.</label>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" id="btnConfirmDeletePoints" class="btn btn-danger fw-bold rounded-pill py-2 shadow-sm disabled">EJECUTAR ELIMINACIÓN</button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- NUEVO: MODAL PARA CAMBIAR PIN -->
<div class="modal fade" id="changePinModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('perfil.cambiar_pin') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-key-fill me-2"></i>Personalizar PIN</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <label class="form-label x-small fw-bold text-uppercase text-secondary">Nuevo PIN (6-8 caracteres)</label>
                    <input type="text" name="nuevo_pin" class="form-control form-control-lg text-center fw-bold border-primary text-primary text-uppercase" placeholder="ALFA123" minlength="6" maxlength="8" required oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                    <small class="text-muted d-block mt-2 x-small lh-sm">
                        Solo letras y números. Debe ser único en La Tribu.
                    </small>
                </div>
                <div class="alert alert-warning x-small border-0 py-2 mb-0">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> ¡No lo olvides! Lo necesitarás para entrar.
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary fw-bold rounded-pill shadow-sm">GUARDAR PIN</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 1. CANJEAR AVENTURA -->
<div class="modal fade" id="redeemAdventureModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('puntos.canjear_aventura') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-warning text-dark border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-ticket-detailed me-2"></i>Canjear Aventura</h6>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                {% if member.puntos_totales >= 5000 %}
                    <div class="alert alert-success border-0 small py-2 mb-3">
                        <i class="bi bi-check-circle-fill me-1"></i> Saldo disponible para canje (>5,000 pts).
                    </div>
                    <div class="mb-3">
                        <label class="form-label x-small fw-bold text-uppercase">Selecciona Aventura Activa</label>
                        <select name="event_id" class="form-select border-warning shadow-none mb-2" required>
                            <option value="" disabled selected>Seleccione una ruta...</option>
                            {% if eventos_activos %}
                                {% for ev in eventos_activos %}
                                <option value="{{ ev.id }}">{{ ev.title }} ({{ ev.event_date }})</option>
                                {% endfor %}
                            {% else %}
                                <option disabled>Cargando lista o no disponible...</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label x-small fw-bold text-uppercase">Puntos a Descontar</label>
                        <input type="number" name="costo_puntos" class="form-control form-control-lg text-center fw-bold border-warning text-danger" placeholder="Ej: 5000" min="1" max="{{ member.puntos_totales }}" required>
                        <small class="text-muted d-block mt-1 x-small">Este monto se restará del saldo del miembro.</small>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-warning fw-bold rounded-pill shadow-sm text-dark">CONFIRMAR CANJE</button>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-lock-fill text-muted display-4 opacity-25 mb-3 d-block"></i>
                        <h5 class="fw-bold text-danger">Saldo Insuficiente</h5>
                        <p class="text-muted small">Necesitas un mínimo de <strong>5,000 puntos</strong> para habilitar los canjes de aventuras.</p>
                        <button type="button" class="btn btn-light rounded-pill border fw-bold px-4 mt-2" data-bs-dismiss="modal">Entendido</button>
                    </div>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- 2. CANJEAR OTRO -->
<div class="modal fade" id="redeemOtherModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('puntos.canjear_otro') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-dark text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-bag-heart me-2"></i>Canjear Artículo/Otro</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3 text-start">
                    <label class="form-label x-small fw-bold text-uppercase">Descripción del Canje</label>
                    <input type="text" name="descripcion" class="form-control shadow-none" placeholder="Ej: Camiseta Oficial, Fiesta Fin de Año..." required>
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label x-small fw-bold text-uppercase">Costo en Puntos</label>
                    <input type="number" name="costo_puntos" class="form-control form-control-lg text-center fw-bold border-dark text-danger" placeholder="0" min="1" max="{{ member.puntos_totales }}" required>
                </div>
                {% if member.puntos_totales < 5000 %}
                <div class="alert alert-warning border-0 x-small py-2 mb-0">
                    <i class="bi bi-exclamation-triangle me-1"></i> Advertencia: Saldo menor a 5,000 pts.
                </div>
                {% endif %}
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-dark fw-bold rounded-pill shadow-sm">APLICAR CANJE</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 3. COMPRAR PUNTOS -->
<div class="modal fade" id="buyPointsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('puntos.comprar_puntos') }}" method="POST">
            <input type="hidden" name="member_id" value="{{ member.id }}">
            <div class="modal-header bg-success text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-cash-coin me-2"></i>Comprar Puntos</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="text-success mb-3 opacity-25">
                    <i class="bi bi-coin display-3"></i>
                </div>
                <div class="mb-3">
                    <label class="form-label x-small fw-bold text-uppercase text-success">Cantidad a Comprar</label>
                    <input type="number" name="cantidad" class="form-control form-control-lg text-center fw-bold border-success text-success" placeholder="1000" min="1000" max="10000" step="100" required>
                    <small class="text-muted d-block mt-1 x-small">Rango permitido: 1,000 - 10,000 pts</small>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-success fw-bold rounded-pill shadow-sm">ACREDITAR PUNTOS</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 4. ENVIAR REGALO (ACTUALIZADO) -->
<div class="modal fade" id="giftBirthdayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <form class="modal-content border-0 shadow-lg rounded-5 overflow-hidden" action="{{ url_for('perfil.transferir_regalo') }}" method="POST">
            <input type="hidden" name="sender_id" value="{{ member.id }}">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-bold w-100 text-center"><i class="bi bi-gift-fill me-2"></i>Enviar Regalo Cumple</h6>
                <button type="button" class="btn-close btn-close-white shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                
                <!-- VERIFICAMOS SI HAY CUMPLEAÑEROS (EXCLUYENDO AL USUARIO ACTUAL) -->
                {% set friends_bday = [] %}
                {% if birthdays_today %}
                    {% for b in birthdays_today %}
                        {% if b.id != member.id %}
                            {% set _ = friends_bday.append(b) %}
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if friends_bday %}
                    <div class="text-primary mb-3">
                        <i class="bi bi-balloon-heart-fill display-3"></i>
                    </div>
                    <p class="small text-muted mb-3">
                        ¡Hoy hay fiesta en la Tribu! Selecciona al amigo que quieres sorprender con tus puntos.
                    </p>
                    
                    <div class="mb-3 text-start">
                        <label class="form-label x-small fw-bold text-uppercase text-primary">Para:</label>
                        <select name="recipient_id" class="form-select border-primary shadow-none" required>
                            {% for friend in friends_bday %}
                                <option value="{{ friend.id }}">{{ friend.nombre }} {{ friend.apellido1 }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label x-small fw-bold text-uppercase text-primary">Puntos a Regalar</label>
                        <input type="number" name="cantidad" class="form-control form-control-lg text-center fw-bold border-primary text-primary" placeholder="500" min="100" max="{{ member.puntos_totales }}" required>
                        <small class="text-muted d-block mt-1 x-small">Se descontarán de tu saldo.</small>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary fw-bold rounded-pill shadow-sm">ENVIAR PUNTOS</button>
                    </div>
                {% else %}
                    <div class="text-muted mb-3 opacity-25">
                        <i class="bi bi-calendar-x display-3"></i>
                    </div>
                    <h6 class="fw-bold text-secondary mb-2">No hay cumpleañeros hoy.</h6>
                    <p class="small text-muted mb-3">
                        Nadie en la Tribu (excepto tú, si fuera el caso) cumple años hoy para recibir regalos.
                    </p>
                    <div class="alert alert-info border-0 x-small py-2 mt-2">
                        <i class="bi bi-clock me-1"></i> Fecha Sistema: <strong>{{ now.strftime('%d/%m') }}</strong>
                    </div>
                    <button type="button" class="btn btn-light rounded-pill border w-100 fw-bold" data-bs-dismiss="modal">Cerrar</button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<script>
    /**
     * Lógica para el modal avanzado de gestión de puntos (ADMIN)
     */
    function checkDeleteSteps() {
        const s1 = document.getElementById('step1_del').checked;
        const s2 = document.getElementById('step2_del').checked;
        const s3 = document.getElementById('step3_del').checked;
        const btn = document.getElementById('btnConfirmDeletePoints');
        
        if (s1 && s2 && s3) {
            btn.classList.remove('disabled');
        } else {
            btn.classList.add('disabled');
        }
    }
</script>

<style>
    .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
    .x-small { font-size: 0.7rem; }
    .transition-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .transition-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important; }
    .hover-scale:hover { transform: scale(1.1); transition: transform 0.2s; }
    .cursor-pointer { cursor: pointer; }
    .border-end-md { border-right: none; }
    
    @media (min-width: 768px) {
        .border-end-md { border-right: 1px solid rgba(0,0,0,0.1); }
    }
    
    /* Ajuste de degradado para modo oscuro si lo usas */
    [data-bs-theme="dark"] .bg-white { background-color: #212529 !important; }
    [data-bs-theme="dark"] .text-dark { color: #f8f9fa !important; }
    [data-bs-theme="dark"] .list-group-item { background-color: #212529; border-color: #333; }
</style>
{% endblock %}