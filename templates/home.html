{% extends "base.html" %}

{% block title %}Pr√≥ximas Aventuras - La Tribu{% endblock %}

{% block content %}
{# Mapeo de meses en espa√±ol para visualizaci√≥n #}
{% set meses = ['', 'enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'] %}

<!-- ========================================== -->
<!-- SECCI√ìN DE ENCABEZADO -->
<!-- ========================================== -->
<div class="row align-items-center mb-4 animate__animated animate__fadeIn">
    <div class="col-lg-12 text-center">
        <div class="d-inline-block p-2 bg-warning bg-opacity-10 rounded-pill mb-3">
            <span class="text-warning fw-bold small px-4 text-uppercase" style="letter-spacing: 3px;">Somos muy Diferentes</span>
        </div>
        <h1 class="display-3 fw-bold mb-0">Camina con La Tribu</h1>
        <p class="lead text-muted mt-2 mx-auto" style="max-width: 700px;">
            Calendario oficial de caminatas de La Tribu de Los Libres. ¬°Suma puntos y conquista retos!
        </p>
    </div>
</div>

<!-- ========================================== -->
<!-- SECCI√ìN: ACCESO R√ÅPIDO A PERFIL (√ÅREA DEL CAMINANTE) -->
<!-- ========================================== -->
<div class="row justify-content-center mb-5 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
    <div class="col-md-8 col-lg-6">
        <div class="card border-0 shadow-lg rounded-5 overflow-hidden position-relative">
            <!-- Fondo Decorativo -->
            <div class="position-absolute top-0 start-0 w-100 h-100 bg-warning bg-opacity-10" style="z-index: 0;"></div>
            
            <div class="card-body p-4 text-center position-relative" style="z-index: 1;">
                <div class="d-flex justify-content-center align-items-center mb-3">
                    <div class="bg-white p-2 rounded-circle shadow-sm me-2 text-warning">
                        <i class="bi bi-person-badge-fill fs-4"></i>
                    </div>
                    <h5 class="fw-bold mb-0 text-dark">√Årea del Caminante</h5>
                </div>
                
                <p class="text-muted small mb-4">
                    Ingresa tu PIN para consultar tu nivel, saldo de puntos y pr√≥ximas expediciones. Tu Pin Puede ser modificado en tu perfil.
                </p>
                
                <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden border border-warning bg-white">
                    <input type="text" id="quickPinInput" class="form-control border-0 text-center fw-bold text-primary fs-4" placeholder="PIN..." maxlength="6">
                    <button class="btn btn-warning fw-bold text-dark px-4 transition-hover" type="button" onclick="goToProfileQuick()">
                        <span class="ver-text">VER </span>MI PERFIL <i class="bi bi-arrow-right-short ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- GRID DE ACTIVIDADES PR√ìXIMAS (AGRUPADO POR MES) -->
<!-- ========================================== -->
<div class="row g-4">
    {% if events %}
        {# Inicializamos la variable para rastrear el cambio de mes #}
        {% set last_month = namespace(value=none) %}

        {% for event in events %}
        
            {# L√≥gica de Separador de Mes #}
            {% if last_month.value != event.event_date.month %}
                <div class="col-12 mt-5 mb-2 animate__animated animate__fadeIn">
                    <div class="d-flex align-items-center gap-3">
                        <h2 class="fw-bold text-warning mb-0 text-uppercase" style="letter-spacing: 2px;">
                            <i class="bi bi-calendar-check me-2"></i>{{ meses[event.event_date.month] }}
                        </h2>
                        <div class="flex-grow-1">
                            <hr class="border-warning border-2 opacity-50 my-0">
                        </div>
                    </div>
                </div>
                {% set last_month.value = event.event_date.month %}
            {% endif %}
            
            <!-- C√ÅLCULO DE CUPOS EN TIEMPO REAL -->
            {# Filtramos solo las reservas con estado 'Activo' #}
            {% set active_bookings = event.bookings | selectattr("status", "equalto", "Activo") | list %}
            {% set ocupados = active_bookings | length %}
            {% set disponibles = event.capacity - ocupados %}
            
            <!-- L√ìGICA DE FECHA PASADA -->
            {% set es_pasado = event.event_date < now.date() %}
            
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 shadow-sm border border-secondary border-opacity-25 overflow-hidden position-relative adventure-card animate__animated animate__fadeInUp" style="animation-delay: {{ loop.index0 * 0.1 }}s">
                    
                    <!-- ACCIONES DE ADMIN (VISUALIZACI√ìN FLOTANTE) -->
                    {% if current_user.is_authenticated and current_user.is_superuser %}
                    <div class="position-absolute top-0 end-0 m-3 z-3 d-flex gap-2">
                        
                        <!-- BOT√ìN ESPECIAL: CONCLUIR CAMINATA (Solo si ya pas√≥ la fecha) -->
                        {% if es_pasado %}
                        <button class="btn btn-success btn-sm rounded-pill shadow fw-bold border-0 px-3 animate__animated animate__pulse animate__infinite" title="Caminata Concluida - Limpiar" data-bs-toggle="modal" data-bs-target="#concludeModal{{ event.id }}">
                            <i class="bi bi-check-circle-fill me-1"></i>Concluir
                        </button>
                        {% endif %}

                        <button class="btn btn-warning btn-sm rounded-circle shadow text-dark border-0 btn-admin-float" title="Editar Actividad" data-bs-toggle="modal" data-bs-target="#editModal{{ event.id }}">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        
                        <button class="btn btn-white btn-sm rounded-circle shadow text-danger border-0 btn-admin-float" title="Eliminar Radical" data-bs-toggle="modal" data-bs-target="#deleteModal{{ event.id }}">
                            <i class="bi bi-trash3-fill"></i>
                        </button>
                    </div>
                    {% endif %}

                    <!-- BADGE DE ESTADO -->
                    {% if event.status == 'Se Traslado' %}
                    <div class="position-absolute top-0 start-0 m-3 z-3">
                        <span class="badge bg-warning text-dark shadow-sm px-3 py-2 rounded-pill fw-bold border border-dark border-opacity-10 animate__animated animate__pulse animate__infinite">
                            <i class="bi bi-calendar-range me-1"></i> TRASLADADO
                        </span>
                    </div>
                    {% endif %}

                    <!-- CONTENEDOR DE IMAGEN (FLYER) -->
                    <div class="card-img-container" style="height: 300px; background: var(--bs-tertiary-bg); position: relative; overflow: hidden;">
                        {% if event.flyer %}
                            <img src="{{ url_for('static', filename='uploads/flyers/' + event.flyer) }}" 
                                 class="card-img-top w-100 h-100 flyer-zoom" 
                                 style="object-fit: cover; cursor: pointer;" 
                                 alt="{{ event.title }}"
                                 onclick="showFullImage(this.src, this.alt)">
                        {% else %}
                            <div class="w-100 h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                                <i class="bi bi-image display-1 opacity-10"></i>
                                <small class="fw-bold opacity-25">Flyer pendiente</small>
                            </div>
                        {% endif %}
                        
                        <div class="price-overlay position-absolute bottom-0 start-0 w-100 p-4 d-flex justify-content-between align-items-end" style="background: linear-gradient(transparent, rgba(0,0,0,0.8)); pointer-events: none;">
                            <span class="badge bg-dark bg-opacity-75 text-white px-3 py-2 rounded-pill small border border-white border-opacity-25">{{ event.activity_type }}</span>
                            <div class="price-tag">
                                <span class="h3 fw-bold mb-0 text-white shadow-text">{{ event.currency }}{{ "{:,.2f}".format(event.price) }}</span>
                            </div>
                        </div>

                        <!-- OVERLAY DE EVENTO PASADO -->
                        {% if es_pasado %}
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.6); pointer-events: none;">
                            <h2 class="text-white fw-bold border-2 border-white border px-4 py-2 text-uppercase" style="transform: rotate(-15deg);">FINALIZADO</h2>
                        </div>
                        {% endif %}
                    </div>

                    <div class="card-body p-4">
                        <h4 class="card-title fw-bold mb-3 text-truncate-2 title-link">{{ event.title }}</h4>

                        <!-- BLOQUE DE FECHA ESTILO TICKET -->
                        <div class="mb-4 p-3 bg-body-tertiary rounded-4 small border border-warning border-opacity-10 ticket-date">
                            <div class="d-flex align-items-center">
                                <div class="bg-warning bg-opacity-20 p-2 rounded-3 me-3 text-warning">
                                    <i class="bi bi-calendar3 h5 mb-0"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-body">
                                        {% if event.duration_days > 1 %}
                                            Del {{ event.event_date.day }} al {{ event.end_date.day }} de {{ meses[event.end_date.month] }}
                                        {% else %}
                                            {{ event.event_date.day }} de {{ meses[event.event_date.month] }}, {{ event.event_date.year }}
                                        {% endif %}
                                    </div>
                                    <div class="x-small text-muted text-uppercase fw-bold" style="letter-spacing: 1px;">Inicia: {{ event.departure_time }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- LISTA DE PARTICIPANTES (EXCLUSIVO SUPERUSER) -->
                        {% if current_user.is_authenticated and current_user.is_superuser %}
                        <div class="mt-3 p-3 bg-light rounded-4 border border-warning border-opacity-10 mb-4 animate__animated animate__fadeIn">
                            <h6 class="fw-bold x-small text-uppercase text-secondary mb-3 border-bottom pb-1">
                                <i class="bi bi-people-fill me-1 text-warning"></i> Inscritos Activos ({{ ocupados }})
                            </h6>
                            <div class="list-group list-group-flush" style="max-height: 180px; overflow-y: auto;">
                                {% for b in active_bookings %}
                                <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-0 bg-transparent border-0 border-bottom border-light">
                                    <div class="text-truncate me-2">
                                        <div class="small fw-bold text-dark text-truncate" style="max-width: 140px;">{{ b.member.nombre }} {{ b.member.apellido1 }}</div>
                                        <span class="x-small text-muted">PIN: <span class="badge bg-warning bg-opacity-25 text-dark font-monospace" style="font-size: 0.65rem;">{{ b.pin }}</span></span>
                                    </div>
                                    <button class="btn btn-xs btn-outline-danger rounded-pill fw-bold py-1 px-2" 
                                            style="font-size: 0.6rem;"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#withdrawHomeModal{{ b.id }}">
                                        RETIRAR
                                    </button>
                                </div>
                                {% endfor %}
                                {% if not active_bookings %}
                                    <div class="text-center py-2 x-small text-muted italic">Sin inscripciones a√∫n</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- NUEVA DISTRIBUCI√ìN: DATOS, PUNTOS Y CUPOS -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex flex-column gap-1 small text-secondary fw-medium card-meta-data">
                                <div><i class="bi bi-signpost-split-fill me-2 text-warning"></i>{{ event.distance or 'Por definir' }}</div>
                                <div><i class="bi bi-speedometer2 me-2 text-warning"></i>{{ event.difficulty }}</div>
                                
                                <!-- CONTADOR DE ESPACIOS DISPONIBLES (EN CARD) -->
                                <div class="{{ 'text-danger fw-bold animate__animated animate__pulse animate__infinite' if disponibles <= 5 and disponibles > 0 else '' }}">
                                    <i class="bi bi-person-walking me-2 text-warning"></i>
                                    {% if disponibles > 0 %}
                                        {{ disponibles }} lugares disponibles
                                    {% else %}
                                        <span class="badge bg-danger">AGOTADO</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- BADGE DE PUNTOS VISIBLE EN LA CARD -->
                            <div class="text-end">
                                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3 py-2 fw-bold shadow-sm points-badge" title="Recompensa por completar">
                                    <i class="bi bi-star-fill me-1"></i> +{{ event.points_reward or 10 }} pts
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer bg-body border-0 p-4 pt-0">
                        {% if es_pasado %}
                             <button class="btn btn-secondary rounded-pill fw-bold py-3 w-100 disabled" disabled>Evento Finalizado</button>
                        {% elif disponibles > 0 %}
                            <button class="btn btn-warning rounded-pill fw-bold py-3 shadow-sm w-100 text-dark transition-all btn-main-reserve" data-bs-toggle="modal" data-bs-target="#detailsModal{{ event.id }}">
                                <i class="bi bi-binoculars-fill me-2"></i>Ver Detalles y Reservar
                            </button>
                        {% else %}
                            <button class="btn btn-secondary rounded-pill fw-bold py-3 w-100 disabled" disabled>Cupos Agotados</button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- MODALES DE RETIRO (S√ìLO PARA ADMIN) -->
            {% if current_user.is_authenticated and current_user.is_superuser %}
                {% for b in active_bookings %}
                <div class="modal fade" id="withdrawHomeModal{{ b.id }}" tabindex="-1" style="z-index: 2000;">
                    <div class="modal-dialog modal-sm modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg rounded-5 overflow-hidden">
                            <div class="modal-header bg-warning text-dark border-0 py-3 text-center d-block">
                                <h6 class="modal-title fw-bold">Gestionar Retiro</h6>
                            </div>
                            <div class="modal-body p-4 text-center bg-body">
                                <div class="text-warning mb-3">
                                    <i class="bi bi-exclamation-triangle-fill display-4 opacity-25"></i>
                                </div>
                                <p class="text-body fw-bold mb-1 fs-5">{{ b.member.nombre }}</p>
                                <p class="small text-muted mb-4 px-2">
                                    Se restar√°n los puntos otorgados por <strong>"{{ event.title }}"</strong> autom√°ticamente.
                                </p>
                                
                                <div class="form-check text-start bg-light p-3 rounded-3 mb-4 border">
                                    <input class="form-check-input ms-0 me-2" type="checkbox" id="confirmWithdrawHome{{ b.id }}" onchange="document.getElementById('btnWithdrawHomeSubmit{{ b.id }}').classList.toggle('disabled', !this.checked)">
                                    <label class="form-check-label small fw-bold text-dark" for="confirmWithdrawHome{{ b.id }}">
                                        Confirmo el retiro y el descuento de puntos.
                                    </label>
                                </div>

                                <div class="d-grid gap-2">
                                    <form action="{{ url_for('main.cancel_booking', booking_id=b.id) }}" method="POST">
                                        <button type="submit" id="btnWithdrawHomeSubmit{{ b.id }}" class="btn btn-warning fw-bold rounded-pill shadow-sm py-2 w-100 text-dark disabled">
                                            EFECTUAR RETIRO
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-light fw-bold rounded-pill py-2 border" data-bs-dismiss="modal">VOLVER</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% endif %}

            <!-- ============================================== -->
            <!-- IMPORTACI√ìN DE COMPONENTES MODULARES -->
            <!-- ============================================== -->
            
            <!-- 1. Modal de Reserva (Usuario) -->
            {% include 'modal_reservar.html' %}
            
            <!-- 2. Modales de Administraci√≥n (Editar y Borrar) -->
            {% include 'modales_admin.html' %}

        {% endfor %}
    {% else %}
        <!-- ESTADO VAC√çO -->
        <div class="col-12 text-center py-5">
            <div class="empty-state-card p-5 rounded-5 border border-dashed border-warning border-opacity-50 shadow-sm animate__animated animate__pulse animate__infinite">
                <i class="bi bi-calendar-x display-1 text-warning opacity-25 mb-4 d-block"></i>
                <h3 class="text-muted fw-bold">No hay expediciones pr√≥ximamente</h3>
            </div>
        </div>
    {% endif %}
</div>

<!-- NUEVO: MODAL VISUALIZADOR DE IMAGEN COMPLETA (LIGHTBOX) -->
<div class="modal fade" id="imageLightboxModal" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 position-relative text-center">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 p-2 bg-dark bg-opacity-50 rounded-circle shadow-none z-3" data-bs-dismiss="modal" aria-label="Close"></button>
                <img src="" id="lightboxImage" class="img-fluid rounded-3 shadow-lg" style="max-height: 90vh; object-fit: contain;">
                <h5 id="lightboxTitle" class="text-white mt-3 text-shadow fw-bold display-6"></h5>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================== -->
<!-- SCRIPTS DE L√ìGICA FRONTEND -->
<!-- ============================================================== -->
<script>
    /**
     * Funci√≥n para mostrar imagen completa en Lightbox
     */
    function showFullImage(src, title) {
        const modalEl = document.getElementById('imageLightboxModal');
        const imgEl = document.getElementById('lightboxImage');
        const titleEl = document.getElementById('lightboxTitle');
        
        imgEl.src = src;
        titleEl.innerText = title || '';
        
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    /**
     * L√≥gica de acceso r√°pido al perfil desde el Home
     * ACTUALIZADO: Permite caracteres alfanum√©ricos
     */
    function goToProfileQuick() {
        const pinInput = document.getElementById('quickPinInput');
        const pin = pinInput.value.trim();
        if (pin.length === 6) {
            window.location.href = `/mi-perfil/${pin}`;
        } else {
            alert("Por favor ingresa los 6 caracteres de tu PIN.");
            pinInput.focus();
        }
    }

    // Variable global para controlar el estado de duplicado del tel√©fono
    const phoneDuplicateState = {};

    /**
     * Verifica en tiempo real si el tel√©fono ya existe
     */
    async function checkPhoneExistence(id) {
        const telInput = document.getElementById('resTel' + id);
        const warningDiv = document.getElementById('phoneDuplicateError' + id);
        const formatWarning = document.getElementById('phoneWarning' + id);
        const btnSub = document.getElementById('btnSubmitRes' + id);
        
        const phone = telInput.value.replace(/[^0-9]/g, '');
        
        if (phone.length === 8) {
            try {
                const response = await fetch(`/api/check-phone/${phone}`);
                const data = await response.json();
                
                if (data.exists) {
                    // Si existe, mostramos error y bloqueamos
                    warningDiv.classList.remove('d-none');
                    formatWarning.classList.add('d-none');
                    telInput.classList.add('is-invalid', 'border-danger');
                    telInput.classList.remove('border-warning');
                    
                    // Bloqueamos el bot√≥n
                    btnSub.classList.add('disabled');
                    phoneDuplicateState[id] = true;
                } else {
                    // Si no existe, limpiamos
                    warningDiv.classList.add('d-none');
                    telInput.classList.remove('is-invalid', 'border-danger');
                    telInput.classList.add('border-warning');
                    phoneDuplicateState[id] = false;
                    
                    // Re-verificamos el resto del formulario
                    checkInputs(id);
                }
            } catch (error) {
                console.error("Error verificando tel√©fono:", error);
            }
        } else {
            // Si no tiene 8 d√≠gitos, limpiamos el error de duplicado (el de formato se encarga checkInputs)
            warningDiv.classList.add('d-none');
            telInput.classList.remove('is-invalid', 'border-danger');
            telInput.classList.add('border-warning');
            phoneDuplicateState[id] = false;
        }
    }

    /**
     * Valida y formatea los inputs del formulario de reserva
     * ACTUALIZADO: Se permite validaci√≥n de PIN alfanum√©rico en reserva tambi√©n
     */
    function checkInputs(id) {
        const nomI = document.getElementById('resNombre' + id);
        const ap1I = document.getElementById('resApellido1' + id);
        const ap2I = document.getElementById('resApellido2' + id);
        const telI = document.getElementById('resTel' + id);
        const bdtI = document.getElementById('resBirthDate' + id);
        const pinI = document.getElementById('lookupPin' + id);

        const formatStrict = (inputElement) => {
            if (!inputElement) return "";
            let value = inputElement.value;
            value = value.replace(/[^a-zA-Z√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö√º√ú]/g, '');
            if (value.length > 0) {
                value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
            }
            if (inputElement.value !== value) {
                inputElement.value = value;
            }
            return value;
        };

        const formatTitle = (inputElement) => {
            if (!inputElement) return "";
            let value = inputElement.value;
            value = value.replace(/[^a-zA-Z√±√ë√°√©√≠√≥√∫√Å√â√ç√ì√ö√º√ú ]/g, '');
            if (value.length > 0) {
                const words = value.split(' ');
                for (let i = 0; i < words.length; i++) {
                    if (words[i].length > 0) {
                        words[i] = words[i].charAt(0).toUpperCase() + words[i].slice(1).toLowerCase();
                    }
                }
                value = words.join(' ');
            }
            if (inputElement.value !== value) {
                inputElement.value = value;
            }
            return value;
        };

        const nombre = formatStrict(nomI);
        const ap1 = formatStrict(ap1I);
        const ap2 = formatTitle(ap2I);

        // Validaci√≥n de Tel√©fono (Solo n√∫meros, max 8)
        if (telI) {
            let telVal = telI.value.replace(/[^0-9]/g, '').substring(0, 8);
            if (telI.value !== telVal) telI.value = telVal;
            
            const warning = document.getElementById('phoneWarning' + id);
            const isTelValid = telVal.length === 8 && ['6', '7', '8'].includes(telVal[0]);

            // Solo mostramos advertencia de formato si NO hay error de duplicado activo
            if (!phoneDuplicateState[id]) {
                if (telVal.length > 0) {
                    warning.classList.toggle('d-none', isTelValid);
                } else {
                    warning.classList.add('d-none');
                }
            } else {
                warning.classList.add('d-none'); // Prioridad al error de duplicado
            }
        }

        // Validaci√≥n de PIN (ALFANUM√âRICO, 6 CARACTERES)
        // Se removi√≥ la restricci√≥n replace(/[^0-9]/g, '')
        if (pinI) {
            let pinVal = pinI.value; 
            document.getElementById('btnValidatePin' + id).classList.toggle('disabled', pinVal.length !== 6);
        }
        
        // Habilitar bot√≥n de env√≠o si todo es v√°lido
        const btnSub = document.getElementById('btnSubmitRes' + id);
        const telVal = telI ? telI.value : "";
        const isTelValid = telVal.length === 8 && ['6', '7', '8'].includes(telVal[0]);
        
        // Regla: Nombre y Ap1 >= 2 chars, Tel v√°lido, Fecha no vac√≠a Y NO HAY DUPLICADO
        const isValid = nombre.length >= 2 && ap1.length >= 2 && isTelValid && bdtI.value !== '' && !phoneDuplicateState[id];
        
        // Solo habilitamos si es v√°lido. Si es inv√°lido por duplicado, checkPhoneExistence ya lo deshabilit√≥,
        // pero aqu√≠ nos aseguramos de no rehabilitarlo accidentalmente.
        if (isValid) {
            btnSub.classList.remove('disabled');
        } else {
            btnSub.classList.add('disabled');
        }
    }

    function togglePinSection(id) {
        const sec = document.getElementById(`pinEntrySection${id}`), 
              btn = document.getElementById(`btnTogglePin${id}`);
        if (sec.classList.contains('d-none')) { 
            sec.classList.remove('d-none'); 
            btn.innerText = "Cerrar"; 
            setTimeout(() => document.getElementById(`lookupPin${id}`).focus(), 150); 
        } else { 
            sec.classList.add('d-none'); 
            btn.innerText = "Usar PIN"; 
        }
    }

    async function lookupUserByPin(id) {
        const pin = document.getElementById(`lookupPin${id}`).value, 
              btn = document.getElementById(`btnValidatePin${id}`), 
              err = document.getElementById(`pinError${id}`), 
              originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const response = await fetch(`/api/lookup/${pin}`), 
                  data = await response.json();
            if (data.success) {
                // REDIRECT TO PROFILE
                window.location.href = `/mi-perfil/${pin}`;
            } else { 
                err.classList.remove('d-none'); 
            }
        } catch (error) { 
            console.error(error); 
        } finally { 
            btn.innerHTML = originalText; 
        }
    }

    /**
     * Procesa el registro de la reserva
     */
    async function processReservation(id, title, date, price) {
        const payload = {
            nombre: document.getElementById(`resNombre${id}`).value.trim(),
            apellido1: document.getElementById(`resApellido1${id}`).value.trim(),
            apellido2: document.getElementById(`resApellido2${id}`).value.trim(),
            telefono: document.getElementById(`resTel${id}`).value.trim(),
            birth_date: document.getElementById(`resBirthDate${id}`).value,
            event_id: id,
            pin: document.getElementById(`lookupPin${id}`).value.trim() // FIX: Enviar PIN actual para evitar duplicados
        };

        const btn = document.getElementById(`btnSubmitRes${id}`), 
              originalText = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>PROCESANDO...'; 
        btn.classList.add('disabled');

        try {
            const res = await fetch('/api/reserve', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload) 
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById(`reserveFormContainer${id}`).classList.add('d-none');
                document.getElementById(`reserveSuccessContainer${id}`).classList.remove('d-none');
                document.getElementById(`pinDisplay${id}`).innerText = data.pin;
                document.getElementById(`btnSendWa${id}`).onclick = () => {
                    let msg = `*‚úÖ REGISTRO CONFIRMADO - LA TRIBU*%0A%0A¬°Hola ${payload.nombre}! Registrado correctamente para:*%0A*üìç:* ${title}%0A*üìÖ:* ${date}%0A*üí∞:* ${price}%0A*üîë PIN:* ${data.pin}%0A%0A*‚ú® Somos la tribu de los libres ‚ú®*`;
                    window.open(`https://wa.me/506${payload.telefono}?text=${msg}`, '_blank'); 
                    window.location.reload();
                };
            } else { 
                alert("Error: " + data.error); 
                btn.innerHTML = originalText; 
                btn.classList.remove('disabled'); 
            }
        } catch (e) { 
            alert("Error de conexi√≥n."); 
            btn.innerHTML = originalText; 
            btn.classList.remove('disabled'); 
        }
    }

    function exportToWhatsApp(t, ty, p, d, de, ti, di, ds, pi, f, desc) {
        let msg = `*üåü AVENTURA: ${t.toUpperCase()} üåü*%0A*üßó Tipo:* ${ty}%0A*üìÖ Fecha:* ${d}%0A*üí∞ Precio:* ${p}%0A%0A*üìç DETALLES:*%0A‚Ä¢ Salida: ${de}%0A‚Ä¢ Hora: ${ti}%0A‚Ä¢ Nivel: ${di}%0A*‚ú® Somos la tribu de los libres ‚ú®*`;
        window.open(`https://wa.me/?text=${msg}`, '_blank');
    }

    function validateDelete(id) {
        const c1 = document.getElementById('check1' + id).checked, 
              c2 = document.getElementById('check2' + id).checked, 
              btn = document.getElementById('deleteBtn' + id);
        if (c1 && c2) { 
            btn.classList.remove('disabled'); 
            btn.classList.add('animate__animated', 'animate__pulse', 'animate__infinite'); 
        } else { 
            btn.classList.add('disabled'); 
            btn.classList.remove('animate__animated', 'animate__pulse', 'animate__infinite'); 
        }
    }
    
    // Funci√≥n de validaci√≥n para el modal de concluir (2 pasos)
    function validateConclude(id) {
        const c1 = document.getElementById('checkConclude1' + id).checked;
        const c2 = document.getElementById('checkConclude2' + id).checked;
        const btn = document.getElementById('concludeBtn' + id);
        
        if (c1 && c2) {
            btn.classList.remove('disabled');
        } else {
            btn.classList.add('disabled');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // L√≥gica para etiquetas din√°micas en edici√≥n
        document.querySelectorAll('.edit-duration-input').forEach(input => {
            input.addEventListener('input', function() {
                const eid = this.getAttribute('data-event-id'), 
                      label = document.querySelector(`.edit-label-date[data-event-id="${eid}"]`), 
                      container = document.querySelector(`.edit-end-date-container[data-event-id="${eid}"]`);
                if (parseInt(this.value) > 1) { 
                    label.innerText = "Fecha Inicio"; 
                    container.classList.remove('d-none'); 
                } else { 
                    label.innerText = "Fecha Actividad"; 
                    container.classList.add('d-none'); 
                }
            });
        });
        
        // Mostrar campo de fecha si se traslada
        document.querySelectorAll('.edit-status-select').forEach(select => {
            select.addEventListener('change', function() {
                const eid = this.getAttribute('data-event-id'), 
                      container = document.querySelector(`.edit-moved-date-container[data-event-id="${eid}"]`);
                if (this.value === 'Se Traslado') container.classList.remove('d-none'); else container.classList.add('d-none');
            });
        });
    });
</script>

<!-- ============================================================== -->
<!-- ESTILOS AVANZADOS -->
<!-- ============================================================== -->
<style>
    .adventure-card { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 1.5rem !important; background: #ffffff; }
    .adventure-card:hover { transform: translateY(-12px); box-shadow: 0 2rem 5rem rgba(0,0,0,0.18) !important; }
    .flyer-zoom { transition: transform 0.8s ease; }
    .adventure-card:hover .flyer-zoom { transform: scale(1.08); }
    .shadow-text { text-shadow: 2px 2px 8px rgba(0,0,0,0.8); }
    .shadow-2xl { box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.4); }
    .btn-admin-float { width: 35px; height: 35px; padding: 0; display: inline-flex; align-items: center; justify-content: center; }
    .ticket-date { border-left: 5px solid #ffc107 !important; }
    .logistics-value { font-weight: 700; color: #333; }
    .text-truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

    .btn-xs { padding: 0.15rem 0.4rem; font-size: 0.65rem; line-height: 1.2; }
    .x-small { font-size: 0.7rem; }

    [data-bs-theme="dark"] .adventure-card { background: #1a1a1a !important; border: 1px solid #2a2a2a !important; }
    [data-bs-theme="dark"] .card-title, [data-bs-theme="dark"] h1, [data-bs-theme="dark"] h2, [data-bs-theme="dark"] .modal-title, [data-bs-theme="dark"] .text-body { color: #ffffff !important; }
    [data-bs-theme="dark"] .text-secondary, [data-bs-theme="dark"] .text-muted, [data-bs-theme="dark"] .small, [data-bs-theme="dark"] .form-label { color: #ced4da !important; }
    [data-bs-theme="dark"] .logistics-value { color: #f8f9fa !important; }
    [data-bs-theme="dark"] .bg-body-tertiary { background-color: #222222 !important; border: 1px solid #333 !important; }
    [data-bs-theme="dark"] .modal-content { background-color: #121212 !important; color: #f8f9fa !important; border: 1px solid #2c2c2c !important; }
    [data-bs-theme="dark"] .form-control, [data-bs-theme="dark"] .form-select { background-color: #1e1e1e !important; color: #fff !important; border-color: #444 !important; }
    [data-bs-theme="dark"] .btn-warning.text-dark { color: #000 !important; }

    /* Estilo para la tarjeta de imagen en el modal */
    [data-bs-theme="dark"] .thumbnail-card {
        border-color: rgba(255, 193, 7, 0.25) !important; /* Borde naranja sutil en modo oscuro */
    }

    /* MEJORA DE CONTRASTE ESPEC√çFICA PARA MODO OSCURO */
    [data-bs-theme="dark"] .card-meta-data {
        color: #e0e0e0 !important; /* Texto casi blanco para distancia y dificultad */
    }
    [data-bs-theme="dark"] .points-badge {
        color: #75b798 !important; /* Verde claro luminoso para el texto de puntos */
    }

    @media (max-width: 500px) {
        .ver-text { display: none; }
    }
</style>

<!-- Importar Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}